<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BB 反彈 ML 訓練詳表板 - 上低版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        
        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }
        
        .selector-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .status {
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        button {
            flex: 1;
            min-width: 100px;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        
        button:hover {
            transform: scale(1.02);
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .btn-predict {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-reset {
            background: #ddd;
            color: #333;
        }
        
        .btn-health {
            background: #4CAF50;
            color: white;
        }
        
        .result {
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
            border: 2px solid #667eea;
        }
        
        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .result-row:last-child {
            border-bottom: none;
        }
        
        .result-label {
            font-weight: bold;
            color: #333;
        }
        
        .result-value {
            color: #667eea;
            font-weight: bold;
        }
        
        .confidence-bar {
            width: 100%;
            height: 25px;
            background: #eee;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .action-badge {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 10px;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        
        .action-excellent {
            background: #28a745;
            color: white;
        }
        
        .action-good {
            background: #20c997;
            color: white;
        }
        
        .action-moderate {
            background: #ffc107;
            color: #333;
        }
        
        .action-weak {
            background: #fd7e14;
            color: white;
        }
        
        .action-poor {
            background: #dc3545;
            color: white;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .feature-group {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .feature-group h4 {
            color: #667eea;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        
        .feature-input {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .info-box h3 {
            color: #1976D2;
            margin-bottom: 8px;
        }
        
        .info-box p {
            color: #0d47a1;
            font-size: 0.95em;
            line-height: 1.5;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .feature-input {
                grid-template-columns: 1fr;
            }
            
            .selector-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>BB 反彈 ML 訓練詳表板</h1>
            <p>支援22個幣种 × 2個時間框架 - 上低版本</p>
        </div>
        
        <div class="grid">
            <!-- 系統狀態 -->
            <div class="card">
                <h2>系統狀態</h2>
                <div class="info-box">
                    <h3>API 連線狀態</h3>
                    <p id="api-status">檢查中...</p>
                </div>
                <button class="btn-health" onclick="checkHealth()">\u91cd新檢查</button>
                <div id="health-result" style="margin-top: 15px;"></div>
            </div>
            
            <!-- 幣种時間框選擇 -->
            <div class="card">
                <h2>選擇幣种/時間框</h2>
                <div class="selector-row">
                    <div class="form-group">
                        <label>幣种</label>
                        <select id="symbol" onchange="updateAvailableTimeframes()">
                            <option value=""></option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>時間框</label>
                        <select id="timeframe">
                            <option value="15m">15 分鐘</option>
                            <option value="1h">1 小時</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                    已選擇: <strong id="selected-model">-</strong>
                </div>
            </div>
            
            <!-- 快速預設 -->
            <div class="card">
                <h2>快速預設</h2>
                <button class="btn-predict" onclick="loadStrongSignal()" style="width: 100%; margin-bottom: 10px;">
                    強信號
                </button>
                <button class="btn-predict" onclick="loadModerateSignal()" style="width: 100%; margin-bottom: 10px;">
                    中等信號
                </button>
                <button class="btn-predict" onclick="loadWeakSignal()" style="width: 100%; margin-bottom: 10px;">
                    弱信號
                </button>
                <button class="btn-reset" onclick="resetForm()" style="width: 100%;">
                    清空表單
                </button>
            </div>
        </div>
        
        <!-- 特徵輸入 -->
        <div class="card">
            <h2>特徵輸入（可不填程的地污估）</h2>
            <p style="color: #666; margin-bottom: 20px;">填入你想要預測的各項指標，或使用「快速預設」</p>
            
            <!-- K線形態 -->
            <div class="feature-group">
                <h4>K線形態特徵</h4>
                <div class="feature-input">
                    <div class="form-group">
                        <label>body_ratio</label>
                        <input type="number" id="body_ratio" step="0.01" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label>wick_ratio</label>
                        <input type="number" id="wick_ratio" step="0.01" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label>high_low_range</label>
                        <input type="number" id="high_low_range" step="1">
                    </div>
                </div>
            </div>
            
            <!-- 成交量 -->
            <div class="feature-group">
                <h4>成交量特徵</h4>
                <div class="feature-input">
                    <div class="form-group">
                        <label>vol_ratio</label>
                        <input type="number" id="vol_ratio" step="0.1" min="0">
                    </div>
                    <div class="form-group">
                        <label>vol_spike_ratio</label>
                        <input type="number" id="vol_spike_ratio" step="0.1" min="0">
                    </div>
                    <div class="form-group">
                        <label>volume_strength</label>
                        <input type="number" id="volume_strength" step="0.1">
                    </div>
                </div>
            </div>
            
            <!-- 動能 -->
            <div class="feature-group">
                <h4>動能特徵</h4>
                <div class="feature-input">
                    <div class="form-group">
                        <label>rsi</label>
                        <input type="number" id="rsi" step="1" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label>rsi_strength</label>
                        <input type="number" id="rsi_strength" step="0.01" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label>macd</label>
                        <input type="number" id="macd" step="0.001">
                    </div>
                    <div class="form-group">
                        <label>macd_hist</label>
                        <input type="number" id="macd_hist" step="0.001">
                    </div>
                    <div class="form-group">
                        <label>macd_strength</label>
                        <input type="number" id="macd_strength" step="0.01" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label>momentum</label>
                        <input type="number" id="momentum" step="1">
                    </div>
                </div>
            </div>
            
            <!-- BB 特徵 -->
            <div class="feature-group">
                <h4>Bollinger Bands 特徵</h4>
                <div class="feature-input">
                    <div class="form-group">
                        <label>bb_position</label>
                        <input type="number" id="bb_position" step="0.01" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label>bb_width_ratio</label>
                        <input type="number" id="bb_width_ratio" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>lower_touch_depth</label>
                        <input type="number" id="lower_touch_depth" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>upper_touch_depth</label>
                        <input type="number" id="upper_touch_depth" step="0.01">
                    </div>
                </div>
            </div>
            
            <!-- 其他特徵 -->
            <div class="feature-group">
                <h4>其他特徵</h4>
                <div class="feature-input">
                    <div class="form-group">
                        <label>price_slope</label>
                        <input type="number" id="price_slope" step="0.001">
                    </div>
                    <div class="form-group">
                        <label>price_trend (0 or 1)</label>
                        <input type="number" id="price_trend" step="1" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label>close_from_lower</label>
                        <input type="number" id="close_from_lower" step="0.01" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label>close_from_upper</label>
                        <input type="number" id="close_from_upper" step="0.01" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label>volatility_ratio</label>
                        <input type="number" id="volatility_ratio" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>prev_5_trend</label>
                        <input type="number" id="prev_5_trend" step="0.001">
                    </div>
                    <div class="form-group">
                        <label>hour (0-23)</label>
                        <input type="number" id="hour" step="1" min="0" max="23">
                    </div>
                    <div class="form-group">
                        <label>is_high_volume_time (0 or 1)</label>
                        <input type="number" id="is_high_volume_time" step="1" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label>adx (0-100)</label>
                        <input type="number" id="adx" step="1" min="0" max="100">
                    </div>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn-predict" onclick="predictBounce()">預測</button>
                <button class="btn-reset" onclick="resetForm()">清空</button>
            </div>
        </div>
        
        <!-- 預測結果 -->
        <div id="result-container" style="display: none;">
            <div class="card">
                <h2>預測結果</h2>
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>預測中...</p>
                </div>
                <div id="prediction-result"></div>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:5000';
        let availableSymbols = [];
        let availableTimeframes = ['15m', '1h'];
        
        async function initializePage() {
            await loadAvailableModels();
            await checkHealth();
        }
        
        async function loadAvailableModels() {
            try {
                const response = await fetch(`${API_URL}/available_models`);
                const data = await response.json();
                
                availableSymbols = data.symbols;
                availableTimeframes = data.timeframes;
                
                // 增置 symbol 選擇器
                const symbolSelect = document.getElementById('symbol');
                availableSymbols.forEach(symbol => {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = symbol;
                    symbolSelect.appendChild(option);
                });
                
                // 設置預設項目
                if (availableSymbols.length > 0) {
                    symbolSelect.value = availableSymbols[0];
                    updateSelectedModel();
                }
            } catch (error) {
                console.error('Failed to load available models:', error);
            }
        }
        
        function updateAvailableTimeframes() {
            // 當前僅支援 15m 和 1h
            updateSelectedModel();
        }
        
        function updateSelectedModel() {
            const symbol = document.getElementById('symbol').value;
            const timeframe = document.getElementById('timeframe').value;
            document.getElementById('selected-model').textContent = symbol && timeframe ? `${symbol} ${timeframe}` : '-';
        }
        
        async function checkHealth() {
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                
                if (data.status === 'ok') {
                    document.getElementById('api-status').innerHTML = 
                        '<span style="color: #28a745;">API 正常連接</span>';
                    document.getElementById('health-result').innerHTML = `
                        <div class="status success">
                            <strong>幣种:</strong> ${data.available_symbols}<br>
                            <strong>時間框:</strong> ${data.available_timeframes}<br>
                            <strong>模型組合:</strong> ${data.available_symbols * data.available_timeframes}
                        </div>
                    `;
                } else {
                    document.getElementById('api-status').innerHTML = 
                        '<span style="color: #dc3545;">API 未準備</span>';
                }
            } catch (error) {
                document.getElementById('api-status').innerHTML = 
                    '<span style="color: #dc3545;">\u7121法連接 API</span>';
                document.getElementById('health-result').innerHTML = `
                    <div class="status error">
                        <strong>錯誤:</strong> 請確保 API 服勑器正在運行
                    </div>
                `;
            }
        }
        
        function loadStrongSignal() {
            const strongSignal = {
                body_ratio: 0.7, wick_ratio: 0.9, high_low_range: 250,
                vol_ratio: 2.5, vol_spike_ratio: 3.5, rsi: 22, rsi_strength: 0.78,
                macd: -0.01, macd_hist: -0.008, macd_strength: 0.95, momentum: -250,
                bb_position: 0.05, bb_width_ratio: 1.4,
                lower_touch_depth: -0.08, upper_touch_depth: 0.03,
                close_from_lower: 0.15, close_from_upper: 0.85,
                price_slope: -0.025, price_trend: 0,
                volume_strength: 2.2, volatility_ratio: 1.6,
                prev_5_trend: -0.03, hour: 2, is_high_volume_time: 1, adx: 32
            };
            fillForm(strongSignal);
        }
        
        function loadModerateSignal() {
            const moderateSignal = {
                body_ratio: 0.5, wick_ratio: 0.6, high_low_range: 150,
                vol_ratio: 1.5, vol_spike_ratio: 1.8, rsi: 35, rsi_strength: 0.45,
                macd: -0.005, macd_hist: -0.003, macd_strength: 0.5, momentum: -100,
                bb_position: 0.2, bb_width_ratio: 1.1,
                lower_touch_depth: -0.03, upper_touch_depth: 0.015,
                close_from_lower: 0.25, close_from_upper: 0.75,
                price_slope: -0.01, price_trend: 0,
                volume_strength: 1.0, volatility_ratio: 1.1,
                prev_5_trend: -0.01, hour: 12, is_high_volume_time: 0, adx: 22
            };
            fillForm(moderateSignal);
        }
        
        function loadWeakSignal() {
            const weakSignal = {
                body_ratio: 0.2, wick_ratio: 0.3, high_low_range: 80,
                vol_ratio: 0.9, vol_spike_ratio: 1.1, rsi: 45, rsi_strength: 0.1,
                macd: 0.0001, macd_hist: 0.00001, macd_strength: 0.2, momentum: -20,
                bb_position: 0.3, bb_width_ratio: 0.9,
                lower_touch_depth: -0.01, upper_touch_depth: 0.005,
                close_from_lower: 0.2, close_from_upper: 0.8,
                price_slope: 0.005, price_trend: 1,
                volume_strength: 0.3, volatility_ratio: 0.8,
                prev_5_trend: 0.001, hour: 10, is_high_volume_time: 0, adx: 15
            };
            fillForm(weakSignal);
        }
        
        function fillForm(data) {
            Object.keys(data).forEach(key => {
                const input = document.getElementById(key);
                if (input) input.value = data[key];
            });
        }
        
        function resetForm() {
            document.querySelectorAll('input[type="number"]').forEach(input => input.value = '');
            document.getElementById('result-container').style.display = 'none';
        }
        
        async function predictBounce() {
            const symbol = document.getElementById('symbol').value;
            const timeframe = document.getElementById('timeframe').value;
            
            if (!symbol) {
                alert('請選擇一個幣种');
                return;
            }
            
            const features = {};
            document.querySelectorAll('input[type="number"]').forEach(input => {
                if (input.value) {
                    features[input.id] = parseFloat(input.value);
                }
            });
            
            if (Object.keys(features).length === 0) {
                alert('請輸入至少一個特徵值');
                return;
            }
            
            document.getElementById('result-container').style.display = 'block';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('prediction-result').innerHTML = '';
            
            try {
                const response = await fetch(`${API_URL}/predict_bounce`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbol, timeframe, features })
                });
                
                const data = await response.json();
                document.getElementById('loading').style.display = 'none';
                
                if (data.status === 'success') {
                    const prob = (data.success_probability * 100).toFixed(2);
                    
                    let actionBadgeClass = '';
                    if (data.confidence === 'EXCELLENT') actionBadgeClass = 'action-excellent';
                    else if (data.confidence === 'GOOD') actionBadgeClass = 'action-good';
                    else if (data.confidence === 'MODERATE') actionBadgeClass = 'action-moderate';
                    else if (data.confidence === 'WEAK') actionBadgeClass = 'action-weak';
                    else actionBadgeClass = 'action-poor';
                    
                    document.getElementById('prediction-result').innerHTML = `
                        <div class="result">
                            <div class="result-row">
                                <span class="result-label">幣种/時間框</span>
                                <span class="result-value">${data.symbol} ${data.timeframe}</span>
                            </div>
                            <div class="result-row">
                                <span class="result-label">反彈成功概率</span>
                                <span class="result-value">${prob}%</span>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${prob}%;">
                                    ${prob}%
                                </div>
                            </div>
                            
                            <div class="result-row" style="margin-top: 15px;">
                                <span class="result-label">信心級別</span>
                                <span class="action-badge ${actionBadgeClass}">${data.confidence}</span>
                            </div>
                            
                            <div class="result-row">
                                <span class="result-label">建議動作</span>
                                <span class="result-value">${data.action}</span>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('prediction-result').innerHTML = `
                        <div class="status error">
                            <strong>錯誤:</strong> ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('prediction-result').innerHTML = `
                    <div class="status error">
                        <strong>連接錯誤:</strong> 請確保 API 服務器正在運行
                    </div>
                `;
            }
        }
        
        window.addEventListener('load', initializePage);
        document.getElementById('symbol').addEventListener('change', updateSelectedModel);
        document.getElementById('timeframe').addEventListener('change', updateSelectedModel);
    </script>
</body>
</html>
